<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOCX Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4">DOCX Generator</h1>

  <div class="row g-4">
    <!-- Entities -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">Сущности</div>
        <div class="card-body">
          <form id="entityForm" class="row g-2">
            <div class="col-5">
              <input class="form-control" placeholder="Название (ФИО)" id="entName" required />
            </div>
            <div class="col-5">
              <input class="form-control" placeholder="Код ({FIO})" id="entCode" required />
            </div>
            <div class="col-2 d-grid">
              <button class="btn btn-primary" type="submit">Добавить</button>
            </div>
          </form>
          <hr />
          <ul class="list-group" id="entitiesList"></ul>
        </div>
      </div>
    </div>

    <!-- Clients -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">Клиенты</div>
        <div class="card-body">
          <form id="clientForm" class="row g-2">
            <div class="col-9">
              <input class="form-control" placeholder="Имя клиента" id="clientName" required />
            </div>
            <div class="col-3 d-grid">
              <button class="btn btn-primary" type="submit">Добавить</button>
            </div>
          </form>
          <hr />
          <ul class="list-group" id="clientsList"></ul>
        </div>
      </div>
    </div>

    <!-- Values -->
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">Значения для клиента</div>
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Клиент</label>
              <select class="form-select" id="valClient"></select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Сущность</label>
              <select class="form-select" id="valEntity"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Значение</label>
              <input class="form-control" id="valText" />
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" id="btnSetValue">Сохранить</button>
            </div>
          </div>
          <hr />
          <div id="valuesList" class="small"></div>
        </div>
      </div>
    </div>

    <!-- Templates & Generate -->
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">Шаблоны и генерация</div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-6">
              <form id="tplForm" class="row g-2" enctype="multipart/form-data">
                <div class="col-5">
                  <input class="form-control" placeholder="Название шаблона" id="tplName" required />
                </div>
                <div class="col-5">
                  <input type="file" class="form-control" id="tplFile" accept=".docx" required />
                </div>
                <div class="col-2 d-grid">
                  <button class="btn btn-secondary" type="submit">Загрузить</button>
                </div>
              </form>
              <ul class="list-group mt-3" id="tplList"></ul>
            </div>
            <div class="col-md-6">
              <label class="form-label">Клиенты для генерации</label>
              <select class="form-select" id="genClients" multiple size="6"></select>
              <label class="form-label mt-2">Шаблон</label>
              <select class="form-select" id="genTemplate"></select>
              <button class="btn btn-success mt-3" id="btnGenerate">Сгенерировать</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const api = '';

async function fetchJSON(url, opts) {
  const r = await fetch(url, opts);
  if (!r.ok) throw new Error(await r.text());
  return r.headers.get('content-type')?.includes('application/json') ? r.json() : r;
}

async function loadEntities() {
  const data = await fetchJSON('/entities/');
  const list = document.getElementById('entitiesList');
  const sel = document.getElementById('valEntity');
  list.innerHTML = '';
  sel.innerHTML = '';
  data.forEach(e => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<span><code>${e.code}</code> — ${e.name}</span> <span class="badge bg-light text-dark">id ${e.id}</span>`;
    list.appendChild(li);

    const opt = document.createElement('option');
    opt.value = e.id; opt.textContent = `${e.name} ${e.code}`;
    sel.appendChild(opt);
  });
}

async function loadClients() {
  const data = await fetchJSON('/clients/');
  const list = document.getElementById('clientsList');
  const sel1 = document.getElementById('valClient');
  const sel2 = document.getElementById('genClients');
  list.innerHTML = '';
  sel1.innerHTML = '';
  sel2.innerHTML = '';
  data.forEach(c => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<span>${c.name}</span> <span class="badge bg-light text-dark">id ${c.id}</span>`;
    list.appendChild(li);

    const o1 = document.createElement('option'); o1.value = c.id; o1.textContent = c.name; sel1.appendChild(o1);
    const o2 = document.createElement('option'); o2.value = c.id; o2.textContent = c.name; sel2.appendChild(o2);
  });
  loadValues();
}

async function loadValues() {
  const clientId = document.getElementById('valClient').value;
  if (!clientId) return;
  const data = await fetchJSON(`/values/?client_id=${clientId}`);
  const box = document.getElementById('valuesList');
  box.innerHTML = data.map(v => `<code>[${v.entity_id}]</code> ${v.value_text}`).join('<br/>');
}

async function loadTemplates() {
  const data = await fetchJSON('/templates/');
  const list = document.getElementById('tplList');
  const sel = document.getElementById('genTemplate');
  list.innerHTML = '';
  sel.innerHTML = '';
  data.forEach(t => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<span>${t.name}</span> <span class="badge bg-light text-dark">${t.filename}</span>`;
    list.appendChild(li);

    const opt = document.createElement('option'); opt.value = t.id; opt.textContent = `${t.name} (${t.filename})`; sel.appendChild(opt);
  });
}

// forms

document.getElementById('entityForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('entName').value.trim();
  const code = document.getElementById('entCode').value.trim();
  await fetchJSON('/entities/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, code})});
  e.target.reset();
  loadEntities();
});

document.getElementById('clientForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('clientName').value.trim();
  await fetchJSON('/clients/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})});
  e.target.reset();
  loadClients();
});

// values

document.getElementById('valClient').addEventListener('change', loadValues);

document.getElementById('btnSetValue').addEventListener('click', async () => {
  const entity_id = +document.getElementById('valEntity').value;
  const client_id = +document.getElementById('valClient').value;
  const value_text = document.getElementById('valText').value;
  await fetchJSON('/values/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({entity_id, client_id, value_text})});
  document.getElementById('valText').value = '';
  loadValues();
});

// templates

document.getElementById('tplForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('tplName').value.trim();
  const file = document.getElementById('tplFile').files[0];
  const fd = new FormData();
  fd.append('name', name);
  fd.append('file', file);
  await fetchJSON('/templates/upload', {method:'POST', body: fd});
  e.target.reset();
  loadTemplates();
});

// generate

document.getElementById('btnGenerate').addEventListener('click', async () => {
  const genTemplate = +document.getElementById('genTemplate').value;
  const genClients = Array.from(document.getElementById('genClients').selectedOptions).map(o => +o.value);
  if (!genTemplate || genClients.length === 0) { alert('Выберите шаблон и хотя бы одного клиента'); return; }
  const resp = await fetch('/generate/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({template_id: genTemplate, client_ids: genClients})});
  if (!resp.ok) { alert('Ошибка генерации'); return; }
  const blob = await resp.blob();
  let filename = 'generated';
  const disp = resp.headers.get('Content-Disposition');
  if (disp) { const m = /filename=([^;]+)/i.exec(disp); if (m) filename = m[1]; }
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
});

// initial load
loadEntities();
loadClients();
loadTemplates();
</script>
</body>
</html>